# vim: ft=sh
SUBCOMMAND_HELP=$(cat <<EOH
Function to start ngrok with custom configurations.
Fist include this into your script by issuing:

use 'ngrok'

Then, define NGROK_CONFIG with your 'ngrok' configuration, example:

NGROK_CONFIG='
tunnels:
  myservice:
    proto:
      http: 8000
  mygit:
    proto:
      tcp:  9418
'

Later in your code you can call:

ngrok_start "mygit myservice"

This will start 'ngrok' tunnels and output the addresses created.
EOH
)

function _ngrok_path_check() {
  log "checking if ngrok can be found on PATH"
  type -a ngrok &> /dev/null
  [[ $? != 0 ]] && in_red "Can't find 'ngrok', please install from 'https://ngrok.com/download' and add it to your PATH" && exit 1
}

function ngrok_start() {
  local ngrok_tunnels="${*}"

  [[ -z ${NGROK_CONFIG} ]] && in_yellow "NGROK_CONFIG not defined, using default configuration."

  in_cyan "Starting ngrok, use CTRL-C to stop."

  log "ngrok config: ${NGROK_CONFIG}"

  tunnel_re='Tunnel established at (.*)'
  while read line; do
    if [[ ${line} =~ ${tunnel_re} ]]; then
      echo "ngrok tunnel: ${BASH_REMATCH[1]}"
    fi
    log "[ngrok] ${line}"
  done < <(ngrok -log='stdout' -config=<(cat ~/.ngrok <(echo "${NGROK_CONFIG}")) start ${ngrok_tunnels})
}

_ngrok_path_check
